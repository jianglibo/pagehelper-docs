<link
  rel="stylesheet"
  href="{{ '/assets/css/custom.css' | relative_url }}"
/>

{% assign phHash = site.data.file_hashes.ph %} {% assign cmHash =
site.data.file_hashes.cm %}
<script
  type="module"
  ph-not-execute-me
>
  import {
    PageHelper,
    Cm6Enricher,
  } from "{{ site.baseurl }}/forever/ph-{{ phHash }}.js";
  import makecm6 from "{{ site.baseurl }}/forever/cm-{{ cmHash }}.js";

  const pageHelper = new PageHelper({
    debug: true,
    demo_mode: true,
    alpine_before_start: function (Alpine) {
      Alpine.data("demos", () => ({
        loadalldemos: {
          ["@click.prevent"]() {
            fetch("https://lets-script.com/devtools/pagehelpers")
              .then((res) => res.json())
              .then((j) => {
                Alpine.store("demos").all = [
                  ...j.data,
                  Alpine.store("demos").currentItem,
                ];
                history.pushState({}, "", window.location.pathname);
              });
          },
        },
        initdemo: {
          ["x-init"]() {
            const qs = new URLSearchParams(window.location.search);
            if (qs.has("item")) {
              const item = JSON.parse(qs.get("item"));
              Alpine.store("demos").all = [item];
              Alpine.store("demos").currentItem = item;
              Alpine.nextTick(() => {
                const ce = new CustomEvent("demo-change", {});
                window.dispatchEvent(ce);
              });
            } else {
              fetch("https://lets-script.com/devtools/pagehelpers")
                .then((res) => res.json())
                .then((j) => {
                  Alpine.store("demos").all = j.data;
                  const itemid = qs.get("itemid");
                  if (itemid) {
                    Alpine.store("demos").setCurrentItem(itemid);
                    Alpine.nextTick(() => {
                      const ce = new CustomEvent("demo-change", {});
                      window.dispatchEvent(ce);
                    });
                  }
                });
            }
          },
        },
      }));
      Alpine.store("demos", {
        init() {
          this.all = [];
        },
        all: [],
        currentItem: {},
        setCurrentItem(id) {
          console.log("id to set", id);
          const found = this.find(id);
          console.log("found", found);
          this.currentItem = JSON.parse(JSON.stringify(found));
        },
        find(id) {
          return this.all.find((demo) => {
            return demo.id + "" === id;
          });
        },
        currentLink(demoname) {
          const qs = new URLSearchParams();
          if (demoname) {
            this.currentItem.name = demoname;
          }
          if (!this.currentItem.name) {
            this.currentItem.name = "A Pagehelper Demo";
          }
          if (!this.currentItem.id) {
            this.currentItem.id = Math.floor(Math.random() * 1000000) + 1000000;
          }
          qs.set("item", JSON.stringify(this.currentItem));
          return `${window.location.origin}${
            window.location.pathname
          }?${qs.toString()}`;
        },
        copyCurrentLink(demoname) {
          navigator.clipboard.writeText(this.currentLink(demoname));
        },
      });
    },
  });

  pageHelper.add(new Cm6Enricher({ makecm6 }));

  pageHelper.enrich();

  window.addEventListener("pjaxPageLoaded", (e) => {
    var domContentLoadedEvent = new Event("DOMContentLoaded", {
      bubbles: true,
      cancelable: true,
    });
    document.dispatchEvent(domContentLoadedEvent);
  });
</script>
